on:
    workflow_dispatch:
    push:
        tags:
            - "v*"
permissions:
    contents: write

name: Build
jobs:
    build:
        name: Build Pernix Compiler
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [windows-latest, macOS-latest, macOS-13, ubuntu-20.04]
        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - name: Setup Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            - name: Install LLVM 18 on Linux
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y llvm-18-tools llvm-18-dev libz-dev libpolly-18-dev libzstd-dev
                  echo "LLVM_SYS_180_PREFIX=/usr/lib/llvm-18" >> $GITHUB_ENV

            - name: Install LLVM 18 on macOS
              if: runner.os == 'macOS'
              run: |
                  brew install llvm@18
                  echo "LLVM_SYS_180_PREFIX=$(brew --prefix)/opt/llvm@18" >> $GITHUB_ENV
                  brew install zstd
                  echo "PATH=$(brew --prefix)/opt/zstd/lib:$PATH" >> $GITHUB_ENV

            - name: Install LLVM 18 on Windows
              if: runner.os == 'Windows'
              run: |
                  choco install llvm --version=18.1.8 --force
                  echo "LLVM_SYS_180_PREFIX=C:\\Program Files\\LLVM" >> $env:GITHUB_ENV

            - name: Build Pernix Compiler
              run: cargo install --path compiler/pernixc --root .

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: pernixc-${{ matrix.os }}
                  path: bin/pernixc
