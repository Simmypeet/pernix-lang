on:
    workflow_dispatch:
    push:
        tags:
            - "v*"
permissions:
    contents: write

name: Build
jobs:
    build:
        name: Build Pernix Compiler
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os:
                    [
                        windows-latest,
                        macOS-latest,
                        macOS-13,
                        ubuntu-20.04,
                        ubuntu-22.04-arm,
                    ]
        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - name: Setup Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            - name: Install LLVM 18 and Add to LLVM_SYS_180_PREFIX on Ubuntu
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y llvm-18-tools llvm-18-dev
                  echo "export LLVM_SYS_180_PREFIX=/usr/lib/llvm-18" >> $GITHUB_ENV

            - name: Install LLVM 18 on macOS
              if: runner.os == 'macOS'
              run: |
                  brew install llvm@18
                  echo "export LLVM_SYS_180_PREFIX=/usr/local/opt/llvm@18" >> $GITHUB_ENV

            - name: Install LLVM 18 on Windows
              if: runner.os == 'Windows'
              run: |
                  choco install llvm --version=18.0.0
                  echo "export LLVM_SYS_180_PREFIX=C:/Program Files/LLVM" >> $GITHUB_ENV

            - name: Build Pernix Compiler
              run: cargo install --path compiler/pernixc --root .

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: pernix-compiler-{{ runner.os }}
                  path: bin/pernixc
